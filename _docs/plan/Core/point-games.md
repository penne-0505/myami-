---
title: Point Games Plan
status: proposed
draft_status: exploring
created_at: 2025-12-26
updated_at: 2025-12-26
references:
  - _docs/reference/app/bot_client.md
  - _docs/reference/app/facade.md
  - _docs/reference/database/points_repository.md
related_issues: []
related_prs: []
---

## Overview
ポイントを掛けて遊べる5種類のゲーム（スロット/おみくじ/hit&blow/じゃんけん/コイントス）を追加し、結果に応じてポイントを付与または没収する。

## Scope
- テキストコマンド入力（例: `m.slot` 形式）でゲームを起動できるようにする。
- 掛け金を事前に差し引き、結果に応じて倍率でポイントを付与または没収する。
- 5種類のゲームの判定ロジックと表示（テキスト/絵文字）を実装する。

## Non-Goals
- スラッシュコマンドの全面置き換え（既存 `/point` などの変更）。
- 永続ランキングや戦績の保存。
- ギルド外（DM）でのゲーム提供。

## Requirements
- **Functional**:
  - 掛け金は正の整数のみ受け付ける。
  - 掛け金の最小値は100とする。
  - 掛け金が不足している場合は失敗理由を返す。
  - 成功時は「掛け金 -> 結果判定 -> 倍率で付与 or 没収」の流れを共通化する。
  - テキストコマンドのプレフィックスは `m.` を使用する。
  - スロットは絵文字のアニメーションを表示し、揃い方で倍率を変える。
  - おみくじは当たり/外れの固定倍率で、 大吉/大凶は倍率が増加する。
  - hit&blow はクリア時のみ固定倍率で付与する（倍率は高め）。
  - じゃんけんは勝利時のみ固定倍率で付与し、あいこの場合は勝敗がつくまで継続する。
  - コイントスは2択でじゃんけんと同様の固定倍率を適用する。
  - hit&blow は3桁・試行10回まで。開始ユーザーの `quit` で終了でき、120秒タイムアウトで終了する。
  - hit&blow は開始ユーザーの次メッセージを回答として扱う（セッション中）。
- **Non-Functional**:
  - ゲーム結果の乱数はサーバー側で生成する。
  - ユーザー単位で1秒のクールダウンを設ける。
  - 既存ポイント機能（送信/剥奪/ロール購入/VC付与）と競合しない。

## Tasks
- テキストコマンドのパーサを設計し、既存 `on_message` の流れに統合する。
- 掛け金のバリデーションとポイントの差し引き/返却の共通処理を実装する。
- 各ゲームの判定ロジックと倍率定義を実装する。
- スロットのアニメーション表示（メッセージ更新）を実装する。
- 仕様確定後に guide/reference を追加する。

## Test Plan
- 掛け金不足・不正値で適切なエラーを返す。
- 各ゲームの勝敗でポイント増減が正しく行われる。
- スロットの当たりパターンで倍率が正しく反映される。
- 連続実行時にレート制限が想定通り動く（導入する場合）。

## Deployment / Rollout
- 既存機能との衝突がないことを確認後、現行運用と並行で有効化する。

## Open Questions
なし

## Multipliers (Draft)
- コイントス: 勝ち `x1.7` / 負け `x0`
- じゃんけん: 勝ち `x2.0` / 負け `x0` / あいこは勝敗がつくまで継続
- おみくじ:
  - 大吉 `x2.0`
  - 中吉 `x1.7`
  - 小吉 `x1.4`
  - 末吉 `x1.0`（掛け金返却）
  - 凶 `x0`
  - 大凶 `x-0.5`（掛け金の1.5倍を失う）
- hit&blow（クリア時のみ）: クリア `x3.0` / 未クリア `x0`
- スロット（3リール想定）:
  - 3つ揃い（レア絵文字） `x4.5`
  - 3つ揃い（通常絵文字） `x2.5`
  - 2つ揃い `x1.3`
  - 揃いなし `x0`
